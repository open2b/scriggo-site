<!doctype html>
<html lang="en" class="article">
<head>
    <meta charset="utf-8">
    <title>Internals</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="top">
    <a class="logo" href="/">Scriggo</a>
    <ul>
        <li><a href="/news">News</a></li>
        <li><a href="/what-is-scriggo">Documentation</a></li>
        <li><a href="/support">Support</a></li>
        <li><a href="/use-cases">Use Cases</a></li>
        <li><a href="https://play.scriggo.com/" target="_blank" class="playground">Playground</a></li>
    </ul>
    <a class="github-logo" href="https://github.com/open2b/scriggo/" alt="Scriggo on GitHub">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Github | Scriggo</title><path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"/></svg></a>

</nav><article>
    <div class="wrap">
        <aside>
            <nav>
            <ul>
                <li><a href="what-is-scriggo">What is Scriggo</a></li>
                <li><a href="get-started">Get Started</a></li>
                <li><a href="install">Install Scriggo</a></li>
                <li><a href="scriggo-command">Scriggo command</a></li>
                <li><a href="template">Template</a></li>
                <li><a href="scriggofile">Scriggofile</a></li>
                <li><a href="internals">Internals</a></li>
                <li><a href="disassembler">Disassembler</a></li>
                <li><a href="template-spec">Template spec</a></li>
                <li><a href="limitations">Limitations</a></li>
            </ul>
            </nav>
        </aside>
        <div class="content">
            <h1 id="internals">Internals</h1>
<ol>
  <li>
    <a href="#an-overview-of-the-scriggo-implementation">An overview of the Scriggo implementation</a>
    <ol>
      <li>
        <a href="#the-compiler" id="markdown-toc-the-compiler">The compiler</a>
        <ol>
          <li><a href="#the-lexer" id="markdown-toc-the-lexer">The lexer</a></li>
          <li><a href="#the-parser" id="markdown-toc-the-parser">The parser</a></li>
          <li><a href="#the-type-checker">The type checker</a></li>
          <li><a href="#the-emitter">The emitter</a></li>
       </ol>
      </li>
      <li><a href="#the-runtime" id="markdown-toc-the-runtime">The runtime</a></li>
    </ol>
  </li>
</ol>
<h2 id="an-overview-of-the-scriggo-implementation">An overview of the Scriggo implementation</h2>
<p>Scriggo is composed by two main parts:</p>
<ul>
<li>the <strong>compiler</strong></li>
<li>the <strong>runtime</strong></li>
</ul>
<p>The <strong>compiler</strong>, in turn, is composed by:</p>
<ul>
<li>the <strong>lexer</strong></li>
<li>the <strong>parser</strong></li>
<li>the <strong>type checker</strong></li>
<li>the <strong>emitter</strong></li>
</ul>
<p>The <strong>runtime</strong> is implemented on the <strong>Scriggo Virtual Machine</strong>.</p>
<p><img src="/images/internals_overview.png" alt="internals_overview"></p>
<h3 id="the-compiler">The compiler</h3>
<p>The Scriggo compiler takes a source code and generates some bytecode ready to be executed by the virtual machine.</p>
<p>Let's take a look at the entire process.</p>
<h4 id="the-lexer">The lexer</h4>
<p>The lexer reads a source code and outputs a list of <em>tokens</em>.</p>
<p><img src="/images/lexer.png" alt="lexer"></p>
<p>The lexer recognizes all the tokens used by Go plus the ones specific for the template, as <code>{%</code>, <code>%}</code> , <code>macro</code> etc.. To get an overview of the Scriggo template syntax see <a href="/template">the Scriggo templates</a>.</p>
<h4 id="the-parser">The parser</h4>
<p>The <strong>parser</strong> takes the the list of tokens returned by the <strong>lexer</strong> and generates an AST (Abstract Syntax Tree).</p>
<p><img src="/images/parser.png" alt="parser"></p>
<p>In the parser we can se the first main difference between the <em>programs</em>, the <em>scripts</em> and the <em>templates</em>.
For example, the AST representing a program is composed by a tree, that contains a package, that contains a list of declarations.
On the other hand, a script or a template is a tree that holds a list of statements, and does not contain a package.</p>
<h4 id="the-type-checker">The type checker</h4>
<p>The <strong>type checker</strong> performs several operations on the AST given by the <strong>parser</strong>:</p>
<ol>
<li>reorders the declarations, if necessary</li>
<li>make a type check</li>
<li>transform the AST, preparing it for the emission</li>
</ol>
<p><img src="/images/typechecker.png" alt="typechecker"></p>
<p>The type checker is the first part of the compiler where the Scriggo code get in touch with the <em>host</em>; the declarations passed at compilation time are injected into the AST as <em>predefined values</em>.</p>
<p>Before starting with the type checking a <em>dependency analysis</em> is performed on the AST. This analysis has two main purposes: the first is to catch any <em>initialization loop</em>, the second is to find an order for the declarations.</p>
<p>The source code of the type checker can be found in the <code>internal/compiler</code> package:</p>
<ul>
<li><a href="">checker.go</a> declares the type <code>typechecker</code> and some of its methods.</li>
<li><a href="">checker_assignment.go</a> declares functions to perform the type checking of declarations and assignment.</li>
<li><a href="">checker_dependencies.go</a> makes a dependency analysis on the given AST.</li>
<li><a href="">checker_package.go</a> makes a type checking on a package.</li>
<li><a href="">checker_expressions.go</a> performs the type checking of the expressions.</li>
<li><a href="">checker_statements.go</a> declares functions to type check the statements; for example it exports the method <code>checkNodes</code>.</li>
</ul>
<h4 id="the-emitter">The emitter</h4>
<p>The <em>emitter</em> takes the AST and <em>emits</em> the code that will be intepreted by the virtual machine.</p>
<p><img src="/images/emitter.png" alt="emitter"></p>
<p>Since the virtual machine knows nothing about programs, template and scripts, the emitter to make them converge into a list of instructions. For instance, the <code>show</code> statement in the templates (that renders a value) is emitted as a function call to a function that takes a writer and an expression as arguments.</p>
<p>The emitter relies on the <strong>builder</strong>, that knows the internal implementation of the virtual machine and exposes some utility function to the emitter hiding as much as possible the internals details.
Note that, without the use of the builder, the emission of instructions for the virtual machine would be very complex.</p>
<h3 id="the-runtime">The runtime</h3>
<p>The runtime of Scriggo executes the byte code using its internal virtual machine.
For a detailed explanation of the virtual machine and to see the set of the bytecode instructions that it uses, see the section <a href="bytecode">Bytecode</a>.</p>

        </div>
    </div>
</article>
<footer>
    &copy; 2021 Open2b
</footer>
</body>
</html>